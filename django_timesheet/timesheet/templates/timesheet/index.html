{% extends 'timesheet/base.html' %} 
{% load timer static timesheet %} 

{% block styles %}
<link rel="stylesheet" href="{% static 'timesheet/css/index.css' %}" />
{% endblock %}

{% block header %}
<header>
    <div class="container">
        <form action="{% url 'file_list' %}" method="GET">
            {% csrf_token %}
            {% if object_list.pending.count %}
            <div class="index-form-row">
                <div class="index-form-field">
                    {{ form.reference.label_tag }} {{ form.reference }} {{ form.reference.errors }}
                </div>
            </div>
            <div class="button-group">
                <button type="submit">Akten suchen</button>
                <a href="{% url 'file_list' %}">Alle Akten anzeigen</a> 
                {% if object_list.count %}
                <span class="or">oder</span>
                <a href="{% url 'task_archive' %}">Alle Aufgaben anzeigen</a>
                {% endif %}
                </div>
            {% else %}
            <div class="index-form-row">
                <div class="index-form-field">
                    {{ form.reference.label_tag }} {{ form.reference }} {{ form.reference.errors }}
                </div>
                <div class="index-form-field">
                    {{ form.description.label_tag }} {{ form.description }} {{ form.description.errors }}
                </div>
            </div>
            <div class="button-group">
                <button type="submit">Akten suchen</button>
                <a href="{% url 'file_list' %}">Alle Akten anzeigen</a> 
                <span class="or">oder</span>
                <button formaction="{% url 'index' %}" formmethod="POST" type="submit">Aufgabe hinzufügen</button>
                {% if object_list.all.count %}
                <a href="{% url 'task_archive' %}">Alle Aufgaben anzeigen</a>
                {% endif %}
            </div>
            {% endif %}            
        </form>
    </div>
</header>
{% endblock %}

{% block main %}
{% if object_list.pending.count %}
<section class="current-task">
        {% with task=object_list.pending.first %}
        <h1>Aktuelle Aufgabe</h1>
        <div class="row">
            <div class="info-group">
                <span class="label">Aktenzeichen:</span>
                <span class="info"><a href="{{ task.file.get_absolute_url }}">{{ task.file.reference }}</a></span>
            </div>
            <div class="info-group">
                <span class="label">Datum:</span> 
                <span class="info">{{ task.date }}</span>
            </div>
        </div>
        <div class="row">
            <div class="info-group">
                <span class="info"><a href="{{ task.get_absolute_url }}">{{ task.description }}</a></span>
            </div>
            <div>
                <span style="font-style: italic;">
                            {% if task.timer.status == 'paused' %}
                            Timer ist angehalten.
                            {% elif task.timer.status == 'running' %}
                            Timer läuft.
                            {% else %}
                            Bitte starten Sie den Timer.
                            {% endif %}
            </span>
            </div>
            {% render_timer task.timer %}
        </div>
        {% endwith %}
</section>
{% endif %}

{% if object_list.today.count %}
<section>
    <h2>Heutige Aufgaben</h2>
    <table>
        <thead>
            <th>Aktenzeichen</th>
            <th>Beschreibung</th>
            <th>Von</th>
            <th>Bis</th>
            <th>Timer</th>
            <th>Abrechenbar</th>
        </thead>
        {% for task in object_list.today %}
        <tr>
            <td><a href="{{ task.file.get_absolute_url }}">{{ task.file.reference }}</a></td>
            <td><a href="{{ task.get_absolute_url }}">{{ task.description }}</a></td>
            <td>{{ task.timer.segment_set.first.start_time }}</td>
            <td>{{ task.timer.segment_set.last.stop_time | default:'' }}</td>
            <td>{% if task.timer.status == 'running' %}läuft{% else %}{{ task.timer.duration | hhmmss }}{% endif %}</td>
            <td>{{ task.billable | hhmmss }}</td>
        </tr>
        {% endfor %}
        <tr>
            <td colspan="5">Summe</td>
            <td>{{ object_list.today.total_billable_time | hhmmss }}</td>
        </tr>
    </table>
</section>

{% endif %}
{% endblock %} 

{% block scripts %}
<script src="{% static 'django_timer/js/timer.js' %}"></script>
<script src="{% static 'timesheet/js/timesheet.js' %}"></script>
{% endblock %}